---
title: Preparing for Upgrading MySQL for PCF
owner: MySQL
---

<strong><%= modified_date %></strong>

This topic explains how to prepare for upgrading the MySQL for Pivotal Cloud Foundry (PCF) service
and existing service instances.

## <a id="deprecated-bindings"></a>Overview

MySQL for PCF v2.5 requires app and service-key bindings to use BOSH DNS
and does not support bindings that use IP addresses.
But, apps that use older versions of the MySQL service may bind to their instances using an IP address.

To avoid failure and app downtime when upgrading to MySQL for PCF to v2.5,
all apps that bind to the service using an IP address must be re-bound and restarted before you upgrade.

<%# WHAT HAPPENS WITH SERVICE KEYS? DOES JUST TLS FAIL OR DO OTHER THINGS HAPPEN?%>

To give developers time to unbind, rebind, and restart their apps,
perform the upgrade procedures on this page well in advance of upgrading the MySQL for PCF tile.

## <a id="check-bindings"></a> Check for Bindings with IP Addresses

To check for running app or service-key bindings that use IP addresses, do the following:

1. Run the following command and record the BOSH deployment name for your MySQL service broker:

    ```
  bosh deployments
    ```

1. Run the following command, which lists bindings that use IP addresses
or do not use TLS:

    ```
    bosh -d pivotal-mysql-GUID run-errand find-deprecated-bindings
    ```

    Where `pivotal-mysql-GUID` is the BOSH deployment name for your MySQL service broker.
  <br><br>
    For example:

    <pre class="terminal">
    $ bosh -d pivotal-mysql-e3ddd36247fe5b923caf run-errand find-deprecated-bindings
    Using environment '10.0.0.5' as client 'ops_manager'

    Using deployment 'pivotal-mysql-e3ddd36247fe5b923caf'

    Task 148

    Task 148 | 02:42:08 | Preparing deployment: Preparing deployment (00:00:01)
    Task 148 | 02:42:09 | Running errand: dedicated-mysql-broker/63f9ad1e-998e-451e-8c6e-f6211958f6fb (0) (00:00:03)
    Task 148 | 02:42:12 | Fetching logs for dedicated-mysql-broker/63f9ad1e-998e-451e-8c6e-f6211958f6fb (0): Finding and packing log files (00:00:01)

    Task 148 Started Tue Dec 18 02:42:08 UTC 2018
    Task 148 Finished Tue Dec 18 02:42:13 UTC 2018
    Task 148 Duration 00:00:05
    Task 148 done

    Instance   dedicated-mysql-broker/63f9ad1e-998e-451e-8c6e-f6211958f6fb
    Exit Code  0
    Stdout     +---------------------------+--------------------------------------+------------------------+--------------------------+--------------------+-------------------+-----------------------------+
               |          SERVICE          |             SERVICE GUI             |          ORG           |          SPACE           | APP OR SERVICE KEY |       TYPE        |           REASON            |
               +---------------------------+--------------------------------------+------------------------+--------------------------+--------------------+-------------------+-----------------------------+
               | tlsDB                     | a999db0b-176e-4ac8-8342-d72b338d1f0c | MYSQL-ORG-upgrade-test | MYSQL-SPACE-upgrade-test | user-cli           | ServiceKeyBinding | no tls                      |
               | tlsDB                     | a999db0b-176e-4ac8-8342-d72b338d1f0c | MYSQL-ORG-upgrade-test | MYSQL-SPACE-upgrade-test | user-cli           | ServiceKeyBinding | no dns: hostname="10.0.8.6" |
               | upgrade-outdated-instance | 34f26746-fb46-4f14-87bc-e1ddce26f340 | MYSQL-ORG-upgrade-test | MYSQL-SPACE-upgrade-test | cs-accept          | AppBinding        | no dns: hostname="10.0.8.5" |
               | tlsDB                     | a999db0b-176e-4ac8-8342-d72b338d1f0c | MYSQL-ORG-upgrade-test | MYSQL-SPACE-upgrade-test | cs-accept-tls      | AppBinding        | no dns: hostname="10.0.8.6" |
               +---------------------------+--------------------------------------+------------------------+--------------------------+--------------------+-------------------+-----------------------------+
    </pre>

1.Do the [Remove IP-Based Bindings](#remove-bindings) procedure below
for any apps or service keys that list `no dns` in the `REASON` column of the output table.
  <p class="note"><strong>Note</strong>: You do not need to replace bindings listed as <code>no tls</code>.</p>

## <a id="remove-bindings"></a> Remove IP-Based Bindings

<%# WE ARE DELETING THE SERVICE KEY HERE RIGHT? NOT THE SERVICE-KEY BINDING? %>

Some of the following steps require coordination with your app developers. You must remove both
the app bindings and service keys that use IP addresses.



To remove deprecated app bindings, do the following:

1. Have developers replace their IP-based service bindings with bindings that use BOSH DNS.
See [Re-Bind Apps to Use DNS](#rebind-apps) below.
1. Upgrade your service instances to be compatible with BOSH DNS.
See [Upgrade Service Instances](#upgrade-instances) below.

To remove deprecated service keys, do the following:

<%# IS THIS THE BASIC PROCEDURE? %>

1. Delete the service key. See [LINK](). <%# cf delete-service-key %>
1. Recreate the service key to use TLS. See
[Establish a TLS Connection to a Service Instance](./use.html#establish-tls).
1. Rebind the service key. See [LINK](). <%# SAME AS BELOW? %>
1. Upgrade service instances? See [LINK](). <%# SAME AS BELOW? %>
1. Restage? See [LINK](). <%# cf restage %>

### <a id="recreate-key"></a> Recreate Service Keys

<%# a warning that the service key will now be a bosh dns address %>

<%#  Link to how to use this from outside the platform
LINK TO [Obtain the IP Address Using the DNS Lookup App](./use.html#ip-address-lookup) %>

<p class="note warning"><strong>Warning:</strong> When you delete a service key, you lose the triggers,
  routines, and events created by the user. If you want to keep your triggers, routines, or events,
contact <a href="https://pivotal.io/support">Pivotal Support</a>.</p>

1. Delete the service key by running:

    ```
    cf delete-service-key SERVICE-INSTANCE SERVICE-KEY
    ```
    Where:
    + `SERVICE-INSTANCE`
    + `SERVICE-KEY`

1. Recreate the service key to use TLS by doing the procedure in
[Establish a TLS Connection to a Service Instance](./use.html#establish-tls).

### <a id="rebind-apps"></a> Re-Bind Apps to Use DNS

To replace your deprecated service bindings with new service bindings that use DNS hostnames,
developers must do the following for each binding listed in the log error above:

1. To unbind your app from your service instance, run the following command:

    ```
    cf unbind-service APP-NAME SERVICE-INSTANCE
    ```
1. To re-bind your app to your service instance, run the following command:

    ```
    cf bind-service APP-NAME SERVICE-INSTANCE
    ```
1. To restart your app, run the following command:

     ```
     cf restart APP-NAME
     ```

     After you restart all of your apps, your apps can connect to the database and resume service.

1. To ensure that all deprecated service bindings have been replaced, run the following errand:

     ```
     bosh -d pivotal-mysql-GUID run-errand find-deprecated-bindings
     ```

1. Ensure that `no dns` does not appear in the `REASON` column in the output table.

### <a id="upgrade-instances"></a> Upgrade Service Instances

To upgrade your service instances, operators must do the following:

1. Notify the developers who own the apps listed by the `find-deprecated-bindings`above
that you will be upgrading all service instances, which can impact app connectivity to the database.
1. Log in to the BOSH Director by following the procedure in
[Log in to the BOSH Director VM](https://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#log-in).
1. Locate the BOSH deployment name for your MySQL service broker, by running the following command:

    ```
    bosh deployments
    ```
1. Record the BOSH deployment name for the MySQL service broker, which looks like `pivotal-mysql-GUID`.
1. Upgrade all service instances by running the following command:

    ```
    bosh -d pivotal-mysql-GUID run-errand upgrade-all-service-instances
    ```

    Where `pivotal-mysql-GUID` is the value you recorded in the previous step.

1. Notify your developers that, at this time, they will see that apps that do
hostname validation cannot establish a TLS connection to the database.
These apps will output an error similar the following example:

    <pre class="terminal">
    failed to perform TLS handshake with host "10.0.8.5:3306": x509: certificate is valid for 127.0.0.1, not 10.0.8.5
    </pre>
